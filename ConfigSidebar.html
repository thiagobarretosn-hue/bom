<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #f8f9fa;
      --bg-card: #ffffff;
      --font-primary: #202124;
      --font-secondary: #5f6368;
      --accent-blue: #1a73e8;
      --accent-green: #34a853;
      --accent-red: #ea4335;
      --border-color: #e0e0e0;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    }
    html, body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-primary);
      padding: 16px;
      margin: 0;
      color: var(--font-primary);
      font-size: 14px;
    }
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    .header svg {
      width: 32px;
      height: 32px;
      color: var(--accent-blue);
    }
    .header h2 {
      font-size: 18px;
      font-weight: 600;
      margin: 8px 0 0 0;
    }
    .card {
      background-color: var(--bg-card);
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
      border: 1px solid var(--border-color);
    }
    .btn {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      filter: brightness(1.05);
    }
    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .btn-green { background-color: var(--accent-green); color: white; }
    .btn-red   { background-color: var(--accent-red); color: white; }
    .btn-blue  { background-color: var(--accent-blue); color: white; }
    .btn-grey  { background-color: var(--font-secondary); color: white; font-size: 11px; padding: 8px; }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Estilos para o seletor de PDF */
    .pdf-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    .pdf-counter {
      font-size: 12px;
      color: var(--font-secondary);
      text-align: center;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .pdf-list {
      max-height: 180px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px;
      background-color: #f8f9fa;
    }
    .pdf-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .pdf-item:hover {
      background-color: #f1f3f4;
    }
    .pdf-item input {
      margin-right: 10px;
      cursor: pointer;
    }
    .pdf-item label {
      font-size: 13px;
      cursor: pointer;
      flex-grow: 1;
    }
  </style>
</head>
<body>

  <div class="header">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20V16"/></svg>
    <h2>Painel de Controle</h2>
  </div>

  <div class="card">
    <button type="button" class="btn btn-green" id="btn-process" onclick="startProcessing()">
      üìä Gerar Relat√≥rios
    </button>
  </div>

  <div class="card">
    <div class="pdf-controls">
      <button class="btn btn-grey" onclick="selectAll(true)">‚úÖ Selecionar Todos</button>
      <button class="btn btn-grey" onclick="selectAll(false)">‚ùå Limpar Sele√ß√£o</button>
    </div>
    <div class="pdf-counter" id="pdf-counter">Carregando relat√≥rios...</div>
    <div class="pdf-list" id="pdf-list"></div>
    <button type="button" class="btn btn-red" id="btn-export-selected" onclick="exportSelected()" disabled>
      üìÑ Exportar Selecionados
    </button>
  </div>

  <div class="card">
    <button type="button" class="btn btn-blue" id="btn-test" onclick="runTest()">
      üß™ Testar Sistema
    </button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', loadSheetList);

    function toggleAllButtons(disabled) {
        document.getElementById('btn-process').disabled = disabled;
        document.getElementById('btn-export-selected').disabled = disabled || document.querySelectorAll('#pdf-list input:checked').length === 0;
        document.getElementById('btn-test').disabled = disabled;
    }

    function loadSheetList() {
      google.script.run
        .withSuccessHandler(sheets => {
          const container = document.getElementById('pdf-list');
          if (!sheets || sheets.length === 0) {
            container.innerHTML = `<div style="text-align: center; color: var(--font-secondary); padding: 20px 0;">Nenhum relat√≥rio encontrado.</div>`;
          } else {
            container.innerHTML = '';
            sheets.forEach(name => {
              const div = document.createElement('div');
              div.className = 'pdf-item';
              const cleanId = name.replace(/[^a-zA-Z0-9]/g, '_');
              div.innerHTML = `
                <input type="checkbox" id="sheet_${cleanId}" name="${name}" onchange="updateCounter()">
                <label for="sheet_${cleanId}">${name}</label>
              `;
              container.appendChild(div);
            });
          }
          updateCounter(); // Atualiza o contador mesmo se a lista estiver vazia
          toggleAllButtons(false); // Re-habilita os bot√µes ap√≥s carregar a lista
        })
        .withFailureHandler(error => {
          document.getElementById('pdf-list').innerHTML = `<div style="text-align: center; color: var(--accent-red); padding: 20px 0;">Erro ao carregar.</div>`;
          toggleAllButtons(false); // Re-habilita os bot√µes mesmo em caso de erro
        })
        .getReportSheetNames();
    }

    function selectAll(checked) {
      document.querySelectorAll('#pdf-list input[type="checkbox"]').forEach(cb => cb.checked = checked);
      updateCounter();
    }
    
    function updateCounter() {
      const allCheckboxes = document.querySelectorAll('#pdf-list input[type="checkbox"]');
      const selectedCount = document.querySelectorAll('#pdf-list input[type="checkbox"]:checked').length;
      document.getElementById('pdf-counter').textContent = `${selectedCount} de ${allCheckboxes.length} relat√≥rios selecionados`;
      document.getElementById('btn-export-selected').disabled = selectedCount === 0;
    }

    function showToast(message, type, duration = 4000) {
      const existingToast = document.querySelector('.toast');
      if (existingToast) existingToast.remove();
      
      const toast = document.createElement('div');
      toast.className = `toast`;
      toast.style.backgroundColor = type === 'success' ? 'var(--accent-green)' : type === 'error' ? 'var(--accent-red)' : 'var(--font-secondary)';
      toast.style.color = 'white';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }
    
    // --- Server Call Functions ---

    function startProcessing() {
      showToast('Iniciando processamento...', 'info');
      toggleAllButtons(true);
      google.script.run
        .withSuccessHandler(result => {
          if (result && result.success) {
            showToast(`Sucesso! ${result.created} relat√≥rios gerados.`, 'success');
            loadSheetList(); // A lista ser√° recarregada e os bot√µes re-habilitados no final
          } else {
            showToast(result.message || 'Falha no processamento.', 'error');
            toggleAllButtons(false);
          }
        })
        .withFailureHandler(err => {
          showToast(`Erro: ${err.message}`, 'error');
          toggleAllButtons(false);
        })
        .runProcessingWithFeedback(); // Mudado para a fun√ß√£o com Feedback
    }
    
    function exportSelected() {
        const selected = Array.from(document.querySelectorAll('#pdf-list input:checked'))
                              .map(cb => cb.name);
        if (selected.length === 0) return;

        showToast(`Exportando ${selected.length} PDF(s)...`, 'info');
        toggleAllButtons(true);

        google.script.run
            .withSuccessHandler(result => {
                if (result && result.success) {
                    showToast(`${result.exported} PDF(s) exportados para a pasta "${result.folder}".`, 'success');
                } else {
                    showToast(result.message || 'Falha na exporta√ß√£o.', 'error');
                }
                toggleAllButtons(false);
            })
            .withFailureHandler(err => {
                showToast(`Erro: ${err.message}`, 'error');
                toggleAllButtons(false);
            })
            .exportSelectedPDFs(selected);
    }
    
    function runTest() {
        showToast('Executando diagn√≥stico do sistema...', 'info');
        toggleAllButtons(true);
        google.script.run
            .withSuccessHandler(report => {
                // A resposta do `testSystem` foi ajustada no 'code.gs'
                const reportMsg = `Diagn√≥stico: ${report["Modo de Filtro"]} com ${report["Tipologias Selecionadas"]} linhas na origem.`;
                showToast(reportMsg, 'success');
                toggleAllButtons(false);
            })
            .withFailureHandler(err => {
                showToast(`Erro no diagn√≥stico: ${err.message}`, 'error');
                toggleAllButtons(false);
            })
            .testSystem();
    }
  </script>
</body>
</html>
