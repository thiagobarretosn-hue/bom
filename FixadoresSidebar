<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a73e8;
      --success: #34a853;
      --warning: #fbbc04;
      --danger: #ea4335; /* Cor para remo√ß√£o */
      --bg: #f8f9fa;
      --card: #ffffff;
      --border: #e0e0e0;
      /* Estilos para tubos processados (fundo escuro) */
      --disabled: #3a3a3a;
      --disabled-text: #888; 
      --text: #202124;
      --text-light: #5f6368;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html { height: 100%; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%; /* Garante que o body ocupa 100% da janela */
    }

    /* ===== HEADER, TABS, FILTERS ===== */
    .header {
      background: linear-gradient(135deg, var(--primary), #1557b0);
      color: white; padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .header h2 { font-size: 18px; font-weight: 600; margin: 0; }
    .tabs {
      display: flex; gap: 8px; background: white;
      border-bottom: 2px solid var(--border);
      padding: 0 20px; overflow-x: auto; flex-shrink: 0;
    }
    .tab {
      padding: 12px 20px; cursor: pointer; font-weight: 500;
      color: var(--text-light); border-bottom: 3px solid transparent;
      transition: all 0.2s; white-space: nowrap; position: relative;
    }
    .tab:hover { color: var(--primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-badge {
      display: inline-block; background: var(--primary); color: white;
      font-size: 10px; padding: 2px 6px; border-radius: 10px;
      margin-left: 6px; font-weight: 600;
    }
    .tab.active .tab-badge { background: white; color: var(--primary); }
    .filters {
      background: white; padding: 12px 20px;
      border-bottom: 1px solid var(--border); display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px;
      flex-shrink: 0;
    }
    .filter-input {
      padding: 8px 12px; border: 1px solid var(--border);
      border-radius: 6px; font-size: 12px;
      transition: all 0.2s; font-family: inherit;
    }
    .filter-input:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }
    select.filter-input { cursor: pointer; background: white; }

    /* ===== CONTROLS ===== */
    .controls {
      display: flex; gap: 8px; padding: 12px 20px;
      background: white; border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .btn {
      flex: 1; padding: 10px 16px; border: none; border-radius: 6px;
      cursor: pointer; font-weight: 600; font-size: 12px;
      transition: all 0.2s; font-family: inherit;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--text-light); color: white; }
    .btn-danger { background: var(--danger); color: white; } /* Bot√£o de remo√ß√£o */
    
    .btn:hover:not(:disabled) {
      transform: translateY(-1px); filter: brightness(1.1);
    }
    .btn:disabled {
      opacity: 0.5; cursor: not-allowed; transform: none;
    }

    /* ===== PIPE LIST (CONTENT) ===== */
    .content { 
      flex: 1; overflow-y: auto; padding: 16px 20px; 
    }
    .pipe-list { display: grid; gap: 12px; }
    .pipe-item {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 8px; padding: 14px; display: grid;
      grid-template-columns: 30px 1fr; gap: 14px;
      align-items: start; transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .pipe-item:hover:not(.disabled) {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    /* CSS que aplica o fundo cinza escuro */
    .pipe-item.disabled {
      background: var(--disabled);
      opacity: 0.6;
    }

    .pipe-checkbox {
      margin-top: 6px; transform: scale(1.3);
      cursor: pointer; accent-color: var(--primary);
    }
    
    /* ‚úÖ NOVO: Muda a cor do checkbox marcado se for um item desabilitado */
    .pipe-item.disabled .pipe-checkbox:checked {
      accent-color: var(--danger);
    }

    .pipe-info { display: flex; flex-direction: column; gap: 8px; }
    .pipe-desc {
      font-weight: 600; color: var(--text); font-size: 14px;
    }
    
    /* CSS que aplica o texto cinza claro */
    .pipe-item.disabled .pipe-desc {
      color: var(--disabled-text);
    }

    .pipe-meta { display: flex; gap: 8px; flex-wrap: wrap; }
    .meta-tag {
      background: #e8f0fe; color: var(--primary); padding: 4px 10px;
      border-radius: 12px; font-size: 11px; font-weight: 500;
      display: flex; align-items: center; gap: 4px;
    }
    
    /* CSS para tags em itens desabilitados */
    .pipe-item.disabled .meta-tag {
      background: #4a4a4a;
      color: var(--disabled-text);
    }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center; padding: 60px 20px; color: var(--text-light);
    }
    .empty-state svg {
      width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.3;
    }

    /* ===== FOOTER ===== */
    .footer {
      background: white; padding: 16px 20px;
      border-top: 2px solid var(--border); display: flex;
      flex-direction: column; /* Empilha as se√ß√µes */
      gap: 12px; /* Espa√ßo entre estat√≠sticas e bot√µes */
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      flex-shrink: 0;
    }
    .footer-stats { 
      display: flex; 
      gap: 16px; 
      font-size: 12px; 
      justify-content: space-around; /* Distribui as estat√≠sticas */
      flex-wrap: wrap;
    }
    .stat {
      display: flex; align-items: center; gap: 6px; font-weight: 500;
    }
    .stat-value {
      background: var(--primary); color: white; padding: 2px 8px;
      border-radius: 10px; font-weight: 600;
    }
    
    /* ‚úÖ NOVO: Contadores para Inserir/Remover */
    #stat-add .stat-value { background: var(--success); }
    #stat-remove .stat-value { background: var(--danger); }
    
    /* ‚úÖ NOVO: Container para os bot√µes de a√ß√£o */
    .footer-actions {
      display: grid;
      grid-template-columns: 1fr 1fr; /* Dois bot√µes lado a lado */
      gap: 10px;
    }
    .btn-confirm { background: var(--success); color: white; }
    /* btn-danger j√° est√° definido */

    /* ===== STATUS ===== */
    .status {
      position: fixed; bottom: 20px; right: 20px; padding: 12px 20px;
      border-radius: 8px; font-size: 12px; font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none; z-index: 1000;
    }
    .status.success { background: var(--success); color: white; }
    .status.error { background: var(--danger); color: white; }
    .status.info { background: var(--primary); color: white; }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-light); }
  </style>
</head>
<body>
  <div class="header">
    <h2>üîß Incluir Fixadores</h2>
  </div>

  <div class="tabs">
    <div class="tab active" data-filter="all">
      üìã Todos <span class="tab-badge" id="badge-all">0</span>
    </div>
    <div class="tab" data-filter="riser">
      ‚¨ÜÔ∏è Riser <span class="tab-badge" id="badge-riser">0</span>
    </div>
    <div class="tab" data-filter="colgante">
      ‚¨áÔ∏è Colgante <span class="tab-badge" id="badge-colgante">0</span>
    </div>
    <div class="tab" data-filter="processed">
      ‚úÖ Processados <span class="tab-badge" id="badge-processed">0</span>
    </div>
  </div>

  <div class="filters">
    <input type="text" 
           class="filter-input" 
           id="searchBox" 
           placeholder="üîç Buscar por descri√ß√£o...">
    <select class="filter-input" id="filterSection">
      <option value="">üìç Todas Se√ß√µes</option>
    </select>
    <select class="filter-input" id="filterTrade">
      <option value="">üèóÔ∏è Todos Trades</option>
    </select>
    <select class="filter-input" id="filterFloor">
      <option value="">üìê Todos Andares</option>
    </select>
    <select class="filter-input" id="filterDiameter">
      <option value="">üßø Todos Di√¢metros</option>
    </select>
  </div>

  <div class="controls">
    <button class="btn btn-primary" onclick="toggleAll(true)">
      ‚úÖ Selecionar Dispon√≠veis
    </button>
    <button class="btn btn-secondary" onclick="toggleAll(false)">
      ‚ùå Limpar Sele√ß√£o (Todos)
    </button>
  </div>

  <div class="content">
    <div class="pipe-list" id="pipeList"></div>
  </div>

  
  <div class="footer">
    <div class="footer-stats">
      <div class="stat" id="stat-available">
        Dispon√≠veis: <span class="stat-value" id="availableCount">0</span>
      </div>
      <div class="stat" id="stat-processed">
        Processados: <span class="stat-value" id="processedCount">0</span>
      </div>
      <div class="stat" id="stat-add">
        Para Inserir: <span class="stat-value" id="selectedAddCount">0</span>
      </div>
      <div class="stat" id="stat-remove">
        Para Remover: <span class="stat-value" id="selectedRemoveCount">0</span>
      </div>
    </div>
    <div class="footer-actions">
      <button class="btn btn-confirm" id="btnConfirm" onclick="confirmarFixadores()" disabled>
       Inserir
      </button>
      <button class="btn btn-danger" id="btnRemove" onclick="removerFixadores()" disabled>
       Remover
      </button>
    </div>
  </div>

  <div id="status" class="status"></div>

  <script>
    let allPipes = [];
    let filteredPipes = [];
    let currentTab = 'all';

    // ===== INICIALIZA√á√ÉO =====
    window.addEventListener('load', () => {
      loadPipeData();
    });

    function loadPipeData() {
      showStatus('Carregando tubos...', 'info');
      google.script.run
        .withSuccessHandler(initializePipes)
        .withFailureHandler(err => showStatus(`‚ùå ${err.message}`, 'error'))
        .getPipesElegiveis();
    }

    function initializePipes(pipes) {
      allPipes = pipes || [];
      const status = document.getElementById('status');
      if (status.textContent.includes('Carregando')) {
          status.style.display = 'none';
      }
      populateFilters();
      applyFilters(); 
    }

    // ===== FILTROS =====
    function populateFilters() {
      const sections = new Set();
      const trades = new Set();
      const floors = new Set();
      const diameters = new Set();
      
      allPipes.forEach(pipe => {
        if (pipe.section) sections.add(pipe.section);
        if (pipe.trade) trades.add(pipe.trade);
        if (pipe.floor) floors.add(pipe.floor);
        if (pipe.diameter) diameters.add(pipe.diameter);
      });
      
      populateSelect('filterSection', sections, 'üìç');
      populateSelect('filterTrade', trades, 'üèóÔ∏è');
      populateSelect('filterFloor', floors, 'üìê');
      populateSelect('filterDiameter', diameters, 'üßø');
      
      ['searchBox', 'filterSection', 'filterTrade', 'filterFloor', 'filterDiameter']
        .forEach(id => {
          document.getElementById(id).addEventListener('input', applyFilters);
        });
    }

    function populateSelect(selectId, values, icon) {
      const select = document.getElementById(selectId);
      select.options.length = 1; 
      
      const sorted = [...values].sort((a, b) => {
        const aNum = parseFloat(a);
        const bNum = parseFloat(b);
        if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
        return String(a).localeCompare(String(b));
      });
      
      sorted.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = `${icon} ${value}`;
        select.appendChild(option);
      });
    }

    function applyFilters() {
      const search = document.getElementById('searchBox').value.toLowerCase();
      const section = document.getElementById('filterSection').value;
      const trade = document.getElementById('filterTrade').value;
      const floor = document.getElementById('filterFloor').value;
      const diameter = document.getElementById('filterDiameter').value;
      
      filteredPipes = allPipes.filter(pipe => {
        // Tab filter
        if (currentTab === 'riser' && !pipe.isRiser) return false;
        if (currentTab === 'colgante' && pipe.isRiser) return false;
        if (currentTab === 'processed' && !pipe.jaTemFixador) return false;

        // Other filters
        if (search && !pipe.desc.toLowerCase().includes(search)) return false;
        if (section && pipe.section !== section) return false;
        if (trade && pipe.trade !== trade) return false; 
        if (floor && pipe.floor !== floor) return false;
        if (diameter && pipe.diameter !== diameter) return false;

        return true;
      });
      renderPipes();
      updateStats(); 
    }

    // ===== TABS =====
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.filter;
        applyFilters();
      });
    });
    
    // ===== RENDERIZA√á√ÉO (Atualizado) =====
    function renderPipes() {
      const container = document.getElementById('pipeList');
      if (filteredPipes.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <p>Nenhum tubo encontrado com os filtros aplicados</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredPipes.map((pipe, idx) => {
        const globalIdx = allPipes.indexOf(pipe);
        
        const disabled = pipe.jaTemFixador;
        const disabledClass = disabled ? 'disabled' : '';
        const checkMark = disabled ? ' ‚úì' : '';

        return `
          <div class="pipe-item ${disabledClass}">
            <input type="checkbox" 
                   class="pipe-checkbox" 
                   id="pipe_${globalIdx}" 
                   data-index="${globalIdx}"
                   data-processed="${disabled}" 
                   onchange="updateStats()">
            <label for="pipe_${globalIdx}" class="pipe-info">
              <div class="pipe-desc">${pipe.desc}${checkMark}</div>
              <div class="pipe-meta">
                <span class="meta-tag">üìç ${pipe.section}</span>
                <span class="meta-tag">üèóÔ∏è ${pipe.trade}</span>
                <span class="meta-tag">üìê ${pipe.floor}</span>
                <span class="meta-tag">üè¢ ${pipe.unitType}</span>
                ${pipe.diameter ?
                `<span class="meta-tag">üßø ‚åÄ ${pipe.diameter}"</span>` : ''}
                <span class="meta-tag">üìè ${pipe.qty} ${pipe.uom}</span>
              </div>
            </label>
          </div>
        `;
      }).join('');
    }

    // ===== SELE√á√ÉO (Atualizado) =====
    function toggleAll(checked) {
      if (checked) {
        // Seleciona apenas os dispon√≠veis (n√£o-processados)
        document.querySelectorAll('.pipe-checkbox[data-processed="false"]').forEach(cb => {
         cb.checked = true;
        });
      } else {
        // Limpa TODOS os checkboxes
        document.querySelectorAll('.pipe-checkbox').forEach(cb => {
         cb.checked = false;
        });
      }
      updateStats();
    }

    // ===== ESTAT√çSTICAS (Atualizado) =====
    function updateStats() {
      // Contagens globais
      const available = allPipes.filter(p => !p.jaTemFixador).length;
      const processed = allPipes.filter(p => p.jaTemFixador).length;
      const riser = allPipes.filter(p => p.isRiser).length;
      const colgante = allPipes.filter(p => !p.isRiser).length;

      // Contagens de sele√ß√£o
      const selectedToAdd = document.querySelectorAll('.pipe-checkbox[data-processed="false"]:checked').length;
      const selectedToRemove = document.querySelectorAll('.pipe-checkbox[data-processed="true"]:checked').length;

      // Atualiza o footer
      document.getElementById('availableCount').textContent = available;
      document.getElementById('processedCount').textContent = processed;
      document.getElementById('selectedAddCount').textContent = selectedToAdd;
      document.getElementById('selectedRemoveCount').textContent = selectedToRemove;

      // Atualiza os badges das TABS
      document.getElementById('badge-all').textContent = allPipes.length;
      document.getElementById('badge-riser').textContent = riser;
      document.getElementById('badge-colgante').textContent = colgante;
      document.getElementById('badge-processed').textContent = processed;

      // Atualiza os bot√µes de a√ß√£o
      const btnConfirm = document.getElementById('btnConfirm');
      btnConfirm.disabled = selectedToAdd === 0;
      btnConfirm.textContent = selectedToAdd > 0 ? `Inserir (${selectedToAdd})` : 'Inserir';
      
      const btnRemove = document.getElementById('btnRemove');
      btnRemove.disabled = selectedToRemove === 0;
      btnRemove.textContent = selectedToRemove > 0 ? `Remover (${selectedToRemove})` : 'Remover';
    }

    // ===== A√á√ÉO: CONFIRMAR (Atualizado) =====
    function confirmarFixadores() {
      const selected = [];
      // Apanha apenas os checkboxes "n√£o-processados" marcados
      document.querySelectorAll('.pipe-checkbox[data-processed="false"]:checked').forEach(cb => {
        const idx = parseInt(cb.dataset.index);
        selected.push(allPipes[idx]);
      });
      
      if (selected.length === 0) return;

      showStatus(`Processando ${selected.length} tubo(s)...`, 'info');
      document.getElementById('btnConfirm').disabled = true;
      
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            showStatus(`‚úÖ ${result.added} linhas inseridas! Atualizando...`, 'success');
            loadPipeData(); // Recarrega a lista
          } else {
            showStatus(`‚ùå ${result.message}`, 'error');
            document.getElementById('btnConfirm').disabled = false;
          }
        })
        .withFailureHandler(err => {
          showStatus(`‚ùå ${err.message}`, 'error');
          document.getElementById('btnConfirm').disabled = false;
        })
        .processarFixadoresSelecionados(selected);
    }
    
    // ===== ‚úÖ A√á√ÉO: REMOVER (Nova) =====
    function removerFixadores() {
      const selected = [];
      // Apanha apenas os checkboxes "processados" marcados
      document.querySelectorAll('.pipe-checkbox[data-processed="true"]:checked').forEach(cb => {
        const idx = parseInt(cb.dataset.index);
        selected.push(allPipes[idx]);
      });
      
      if (selected.length === 0) return;
      
      // Confirma√ß√£o (opcional, mas recomendado)
      // if (!confirm(`Tem certeza que deseja remover ${selected.length} fixador(es)?`)) {
      //   return;
      // }

      showStatus(`Removendo ${selected.length} fixador(es)...`, 'info');
      document.getElementById('btnRemove').disabled = true;
      
      google.script.run
        .withSuccessHandler(result => {
          if (result.success) {
            showStatus(`‚úÖ ${result.removed} linhas removidas! Atualizando...`, 'success');
            loadPipeData(); // Recarrega a lista
          } else {
            showStatus(`‚ùå ${result.message}`, 'error');
            document.getElementById('btnRemove').disabled = false;
          }
        })
        .withFailureHandler(err => {
          showStatus(`‚ùå ${err.message}`, 'error');
          document.getElementById('btnRemove').disabled = false;
        })
        .removerFixadoresSelecionados(selected); // Chama a nova fun√ß√£o de backend
    }

    // ===== STATUS =====
    function showStatus(msg, type) {
      const status = document.getElementById('status');
      status.textContent = msg;
      status.className = `status ${type}`;
      status.style.display = 'block';
      
      if (type !== 'info') {
        setTimeout(() => status.style.display = 'none', 4000);
      }
    }
  </script>
</body>
</html>
